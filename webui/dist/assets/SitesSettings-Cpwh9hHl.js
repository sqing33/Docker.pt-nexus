import{m as re,r as p,p as P,O as ue,o as de,f as _,z as c,c as b,h as d,u as pe,b as l,w as o,e as m,x as z,X as ce,a3 as me,v as fe,i as A,k as x,l as r,t as L,ai as ge,ah as ve,R as _e,g}from"./index-BE-79Fp_.js";const ke={class:"cookie-view-container"},ye={class:"top-actions cookie-actions glass-pagination"},we={class:"right-action-group"},be={class:"settings-view"},Ve={key:0,class:"role-tag role-both"},Se={key:1,class:"role-tag role-source"},Ce={key:2,class:"role-tag role-target"},he={style:{display:"flex","justify-content":"center","align-items":"center",width:"100%",height:"100%"}},xe={class:"settings-footer glass-pagination"},Ue={class:"pagination-container"},Be={class:"page-size-text"},Pe={key:0,class:"form-tip",style:{color:"#409eff","font-weight":"bold"}},ze={key:1,class:"form-tip",style:{color:"#409eff","font-weight":"bold"}},Le={class:"dialog-footer"},k="/api",Re={__name:"SitesSettings",setup($e){const R=p(!1),T=p([]),E=p(new Set),F=p([]),$=p(!1),M=p(!1),u=p({url:"",key:"",e2e_password:""}),S=p(""),y=p("supported"),f=p({currentPage:1,pageSize:30,total:0}),C=p(!1),J=p(null),n=p({id:null,site:"",nickname:"",base_url:"",special_tracker_domain:"",group:"",cookie:"",passkey:"",speed_limit:0}),j=P(()=>{const t=new Map;for(const e of F.value||[])e&&e.site&&t.set(String(e.site),e);return t}),U=t=>t?.site&&j.value.get(String(t.site))||null,D=t=>{const e=U(t);return e?e.is_source&&e.is_target?"both":e.is_source?"source":e.is_target?"target":"none":"none"},H=t=>{const e=!!t?.has_cookie,s=!!t?.has_passkey,i=["杜比","HDtime","肉丝"].includes(t?.nickname);return e&&(!i||s)},K=P(()=>["supported","source","target"].includes(y.value)),O=P(()=>{let t=T.value||[];if(y.value==="supported"?t=t.filter(s=>{const i=U(s);return!!(i?.is_source||i?.is_target)}):y.value==="source"?t=t.filter(s=>!!U(s)?.is_source):y.value==="target"?t=t.filter(s=>!!U(s)?.is_target):y.value==="seeding"&&(t=t.filter(s=>E.value.has(s.site))),!S.value)return t;const e=S.value.toLowerCase();return t.filter(s=>{const i=(s.nickname||"").toLowerCase(),N=(s.site||"").toLowerCase(),w=(s.group||"").toLowerCase();return i.includes(e)||N.includes(e)||w.includes(e)})}),Y=P(()=>{f.value.total=O.value.length;const t=(f.value.currentPage-1)*f.value.pageSize,e=t+f.value.pageSize;return O.value.slice(t,e)});ue(S,()=>{f.value.currentPage=1}),de(()=>{q(),B()});const q=async()=>{try{const t=await _.get(`${k}/settings`);t.data&&t.data.cookiecloud&&(u.value.url=t.data.cookiecloud.url||"",u.value.key=t.data.cookiecloud.key||"",u.value.e2e_password="")}catch{c.error("加载CookieCloud配置失败！")}},B=async()=>{$.value=!0;try{const[t,e,s]=await Promise.all([_.get(`${k}/sites`,{params:{filter_by_torrents:"all"}}),_.get(`${k}/sites`,{params:{filter_by_torrents:"active"}}),_.get(`${k}/sites/status`)]);T.value=t.data,E.value=new Set((e.data||[]).map(i=>i.site)),F.value=s.data}catch{c.error("获取站点列表失败！")}finally{$.value=!1}},Q=()=>{f.value.currentPage=1},W=({row:t})=>K.value?H(t)?"":"row-config-incomplete":"",X=async()=>{if(!u.value.url||!u.value.key){c.warning("CookieCloud URL 和 KEY 不能为空！");return}M.value=!0;try{await _.post(`${k}/settings`,{cookiecloud:u.value});const t=await _.post(`${k}/cookiecloud/sync`,u.value);if(t.data.success){let e=t.data.message;e&&(e=e.replace(/在 CookieCloud 中另有 \d+ 个未匹配的 Cookie。?/,"")),c.success(`配置已保存. ${e||"同步完成！"}`),await B()}else c.error(t.data.message||"同步失败，但配置已保存。")}catch(t){const e=t.response?.data?.message||"操作失败，请检查网络或后端服务。";c.error(e)}finally{M.value=!1}},G=t=>{const e=JSON.parse(JSON.stringify(t));n.value=e,C.value=!0},Z=async()=>{R.value=!0;try{const t=JSON.parse(JSON.stringify(n.value));t.cookie&&(t.cookie=t.cookie.trim());const e=await _.post(`${k}/sites/update`,t);e.data.success?(c.success(e.data.message),C.value=!1,await B()):c.error(e.data.message||"操作失败！")}catch(t){const e=t.response?.data?.message||"请求失败，请检查网络或后端服务。";c.error(e)}finally{R.value=!1}},ee=t=>{_e.confirm("","警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0,message:`您确定要删除站点【${t.nickname}】吗？<br/>可以通过修改 config.json 然后重启恢复。`}).then(async()=>{try{const e=await _.post(`${k}/sites/delete`,{id:t.id});e.data.success?(c.success("站点已删除。"),await B()):c.error(e.data.message||"删除失败！")}catch(e){const s=e.response?.data?.message||"删除请求失败。";c.error(s)}}).catch(()=>{c.info("操作已取消。")})};return(t,e)=>{const s=m("el-input"),i=m("el-form-item"),N=m("el-icon"),w=m("el-button"),I=m("el-form"),v=m("el-table-column"),V=m("el-tag"),te=m("el-table"),h=m("el-radio-button"),le=m("el-radio-group"),ae=m("el-pagination"),oe=m("el-input-number"),se=m("el-dialog"),ne=fe("loading");return g(),b("div",ke,[d("div",ye,[l(I,{model:u.value,inline:"",class:"cookie-cloud-form"},{default:o(()=>[l(i,{label:"CookieCloud"},{default:o(()=>[l(s,{modelValue:u.value.url,"onUpdate:modelValue":e[0]||(e[0]=a=>u.value.url=a),placeholder:"http://127.0.0.1:8088",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),l(i,{label:"KEY"},{default:o(()=>[l(s,{modelValue:u.value.key,"onUpdate:modelValue":e[1]||(e[1]=a=>u.value.key=a),placeholder:"KEY (UUID)",clearable:"",style:{width:"100px"}},null,8,["modelValue"])]),_:1}),l(i,{label:"端对端密码"},{default:o(()=>[l(s,{modelValue:u.value.e2e_password,"onUpdate:modelValue":e[2]||(e[2]=a=>u.value.e2e_password=a),type:"password","show-password":"",placeholder:"端对端加密密码",clearable:"",style:{width:"125px"}},null,8,["modelValue"])]),_:1}),l(i,null,{default:o(()=>[l(w,{type:"primary",size:"large",onClick:X,loading:M.value},{default:o(()=>[l(N,null,{default:o(()=>[l(z(ce))]),_:1}),e[17]||(e[17]=d("span",null,"同步Cookie",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),d("div",we,[l(s,{modelValue:S.value,"onUpdate:modelValue":e[3]||(e[3]=a=>S.value=a),placeholder:"搜索站点昵称/标识/官组",clearable:"","prefix-icon":z(me),class:"search-input"},null,8,["modelValue","prefix-icon"])])]),pe((g(),b("div",be,[l(te,{data:Y.value,class:"settings-table glass-table",height:"100%","row-class-name":W},{default:o(()=>[l(v,{prop:"nickname",label:"站点昵称",width:"150",sortable:""}),l(v,{label:"支持",width:"90",align:"center"},{default:o(a=>[D(a.row)==="both"?(g(),b("span",Ve," 源/目标 ")):D(a.row)==="source"?(g(),b("span",Se," 源 ")):D(a.row)==="target"?(g(),b("span",Ce," 目标 ")):A("",!0)]),_:1}),l(v,{prop:"site",label:"站点标识",width:"200","show-overflow-tooltip":""}),l(v,{prop:"base_url",label:"基础URL",width:"225","show-overflow-tooltip":""}),l(v,{prop:"group",label:"官组","show-overflow-tooltip":""}),l(v,{label:"限速",width:"200",align:"center"},{default:o(a=>[d("div",he,[a.row.speed_limit==0?(g(),x(V,{key:0,type:"error",size:"small"},{default:o(()=>[...e[18]||(e[18]=[r(" 当前不限速，重启恢复默认限速 ",-1)])]),_:1})):a.row.speed_limit>999?(g(),x(V,{key:1,type:"success",size:"small"},{default:o(()=>[...e[19]||(e[19]=[r(" 不限速 ",-1)])]),_:1})):(g(),x(V,{key:2,type:"primary",size:"small"},{default:o(()=>[r(L(a.row.speed_limit)+" MB/s ",1)]),_:2},1024))])]),_:1}),l(v,{label:"Cookie",width:"100",align:"center"},{default:o(a=>[l(V,{type:a.row.has_cookie?"success":"danger"},{default:o(()=>[r(L(a.row.has_cookie?"已配置":"未配置"),1)]),_:2},1032,["type"])]),_:1}),l(v,{label:"Passkey",width:"100",align:"center"},{default:o(a=>[["hddolby","m-team","hdtime","rousi"].includes(a.row.site)?(g(),x(V,{key:0,type:a.row.has_passkey?"success":"danger"},{default:o(()=>[r(L(a.row.has_passkey?"已配置":"未配置"),1)]),_:2},1032,["type"])):(g(),x(V,{key:1,type:"success"},{default:o(()=>[...e[20]||(e[20]=[r(" 自动获取 ",-1)])]),_:1}))]),_:1}),l(v,{label:"操作",width:"180",align:"center",fixed:"right"},{default:o(a=>[l(w,{type:"primary",icon:z(ge),link:"",onClick:ie=>G(a.row)},{default:o(()=>[...e[21]||(e[21]=[r(" 编辑 ",-1)])]),_:1},8,["icon","onClick"]),l(w,{type:"danger",icon:z(ve),link:"",onClick:ie=>ee(a.row)},{default:o(()=>[...e[22]||(e[22]=[r(" 删除 ",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])])),[[ne,$.value]]),d("div",xe,[l(le,{modelValue:y.value,"onUpdate:modelValue":e[4]||(e[4]=a=>y.value=a),onChange:Q},{default:o(()=>[l(h,{label:"supported"},{default:o(()=>[...e[23]||(e[23]=[r("支持站点",-1)])]),_:1}),l(h,{label:"source"},{default:o(()=>[...e[24]||(e[24]=[r("源站点",-1)])]),_:1}),l(h,{label:"target"},{default:o(()=>[...e[25]||(e[25]=[r("目标站点",-1)])]),_:1}),l(h,{label:"seeding"},{default:o(()=>[...e[26]||(e[26]=[r("做种站点",-1)])]),_:1}),l(h,{label:"all"},{default:o(()=>[...e[27]||(e[27]=[r("所有站点",-1)])]),_:1})]),_:1},8,["modelValue"]),d("div",Ue,[d("div",Be,L(f.value.pageSize)+" 条/页",1),l(ae,{"current-page":f.value.currentPage,"onUpdate:currentPage":e[5]||(e[5]=a=>f.value.currentPage=a),"page-size":f.value.pageSize,"onUpdate:pageSize":e[6]||(e[6]=a=>f.value.pageSize=a),total:f.value.total,layout:"total, prev, pager, next, jumper",background:""},null,8,["current-page","page-size","total"])])]),l(se,{modelValue:C.value,"onUpdate:modelValue":e[16]||(e[16]=a=>C.value=a),title:"编辑站点",width:"700px","close-on-click-modal":!1},{footer:o(()=>[d("span",Le,[l(w,{onClick:e[15]||(e[15]=a=>C.value=!1)},{default:o(()=>[...e[33]||(e[33]=[r("取消",-1)])]),_:1}),l(w,{type:"primary",onClick:Z,loading:R.value},{default:o(()=>[...e[34]||(e[34]=[r(" 保存 ",-1)])]),_:1},8,["loading"])])]),default:o(()=>[l(I,{model:n.value,ref_key:"siteFormRef",ref:J,"label-width":"140px","label-position":"left"},{default:o(()=>[l(i,{label:"站点标识",prop:"site",required:""},{default:o(()=>[l(s,{modelValue:n.value.site,"onUpdate:modelValue":e[7]||(e[7]=a=>n.value.site=a),placeholder:"例如：pt",disabled:""},null,8,["modelValue"]),e[28]||(e[28]=d("div",{class:"form-tip"},"站点标识不可修改。",-1))]),_:1}),l(i,{label:"站点昵称",prop:"nickname",required:""},{default:o(()=>[l(s,{modelValue:n.value.nickname,"onUpdate:modelValue":e[8]||(e[8]=a=>n.value.nickname=a),placeholder:"例如：PT站"},null,8,["modelValue"])]),_:1}),l(i,{label:"基础URL",prop:"base_url"},{default:o(()=>[l(s,{modelValue:n.value.base_url,"onUpdate:modelValue":e[9]||(e[9]=a=>n.value.base_url=a),placeholder:"例如：pt.com"},null,8,["modelValue"]),e[29]||(e[29]=d("div",{class:"form-tip"},"用于拼接种子详情页链接。",-1))]),_:1}),l(i,{label:"Tracker域名",prop:"special_tracker_domain"},{default:o(()=>[l(s,{modelValue:n.value.special_tracker_domain,"onUpdate:modelValue":e[10]||(e[10]=a=>n.value.special_tracker_domain=a),placeholder:"例如：pt-tracker.com"},null,8,["modelValue"]),e[30]||(e[30]=d("div",{class:"form-tip"}," 如果站点的Tracker域名与主域名的二级域名（则域名去掉前缀后缀部分）不同，请在此填写。 ",-1))]),_:1}),l(i,{label:"关联官组",prop:"group"},{default:o(()=>[l(s,{modelValue:n.value.group,"onUpdate:modelValue":e[11]||(e[11]=a=>n.value.group=a),placeholder:"例如：PT, PTWEB"},null,8,["modelValue"]),e[31]||(e[31]=d("div",{class:"form-tip"},"用于识别种子所属发布组，多个组用英文逗号(,)分隔。",-1))]),_:1}),l(i,{label:"Cookie",prop:"cookie"},{default:o(()=>[l(s,{modelValue:n.value.cookie,"onUpdate:modelValue":e[12]||(e[12]=a=>n.value.cookie=a),type:"textarea",rows:3,placeholder:"从浏览器获取的Cookie字符串"},null,8,["modelValue"])]),_:1}),l(i,{label:"Passkey",prop:"passkey"},{default:o(()=>[l(s,{modelValue:n.value.passkey,"onUpdate:modelValue":e[13]||(e[13]=a=>n.value.passkey=a),placeholder:"站点的Passkey"},null,8,["modelValue"]),n.value.site==="hddolby"?(g(),b("div",Pe," 杜比的passkey为种子详情页复制种子链接时downhash=后的部分 ")):n.value.site==="newrousi"?(g(),b("div",ze," 肉丝的passkey为个人用户-设置-passkey ")):A("",!0)]),_:1}),l(i,{label:"上传限速 (MB/s)",prop:"speed_limit"},{default:o(()=>[l(oe,{modelValue:n.value.speed_limit,"onUpdate:modelValue":e[14]||(e[14]=a=>n.value.speed_limit=a),min:0,max:1e3,placeholder:"为防止失误操作导致超速，当设置为 0 时重启会自动设置为默认限速",style:{width:"100%"}},null,8,["modelValue"]),e[32]||(e[32]=d("div",{class:"form-tip",style:{color:"red","font-size":"14px"}},[r(" 单位为 MB/s，为防止误操作导致超速，当设置为 0 时重启会恢复默认限速"),d("br"),r(" 如缺点设置不限速可输入一个极大的数值，超过 999 会显示不限速 ")],-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},De=re(Re,[["__scopeId","data-v-734aaf94"]]);export{De as default};
