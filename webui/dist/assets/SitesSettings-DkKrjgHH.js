import{m as re,r as p,p as P,O as ue,o as de,f as k,z as c,c as b,h as d,u as pe,b as o,w as a,e as m,x as z,X as ce,a3 as me,v as ge,j as J,l as h,i as r,t as B,ai as fe,ah as ve,R as _e,g as f}from"./index-D3C4dtEM.js";const ke={class:"cookie-view-container"},ye={class:"top-actions cookie-actions glass-pagination"},we={class:"right-action-group"},be={class:"settings-view"},Ve={key:0,class:"role-tag role-both"},Se={key:1,class:"role-tag role-source"},Ce={key:2,class:"role-tag role-target"},he={style:{display:"flex","justify-content":"center","align-items":"center",width:"100%",height:"100%"}},xe={class:"settings-footer glass-pagination"},Ue={class:"pagination-container"},Pe={class:"page-size-text"},ze={key:0,class:"form-tip",style:{color:"#409eff","font-weight":"bold"}},Be={key:1,class:"form-tip",style:{color:"#409eff","font-weight":"bold"}},Le={class:"dialog-footer"},y="/api",Re={__name:"SitesSettings",setup($e){const L=p(!1),E=p([]),I=p(new Set),F=p([]),R=p(!1),$=p(!1),u=p({url:"",key:"",e2e_password:""}),x=p(""),S=p("existing_supported"),g=p({currentPage:1,pageSize:30,total:0}),C=p(!1),K=p(null),i=p({id:null,site:"",nickname:"",base_url:"",special_tracker_domain:"",group:"",cookie:"",passkey:"",speed_limit:0}),Y=P(()=>{const t=new Map;for(const e of F.value||[])e&&e.site&&t.set(String(e.site),e);return t}),M=t=>t?.site&&Y.value.get(String(t.site))||null,N=t=>{const e=M(t);return e?e.is_source&&e.is_target?"both":e.is_source?"source":e.is_target?"target":"none":"none"},T=t=>{const e=!!t?.has_cookie,s=!!t?.has_passkey,n=["hddolby","m-team","hdtime","rousi"].includes(t?.site);return e&&(!n||s)},O=P(()=>["existing_supported","supported"].includes(S.value)),j=P(()=>{let t=E.value||[];S.value==="existing_supported"?t=t.filter(s=>{const n=M(s);return!!(n?.is_source||n?.is_target)&&I.value.has(s.site)}):S.value==="supported"&&(t=t.filter(s=>{const n=M(s);return!!(n?.is_source||n?.is_target)}));const e=x.value.trim().toLowerCase();return e&&(t=t.filter(s=>{const n=(s.nickname||"").toLowerCase(),w=(s.site||"").toLowerCase(),v=(s.group||"").toLowerCase();return n.includes(e)||w.includes(e)||v.includes(e)})),O.value?t.slice().sort((s,n)=>{const w=T(s)?0:1,v=T(n)?0:1;return w!==v?v-w:String(s?.nickname||"").localeCompare(String(n?.nickname||""))}):t}),q=P(()=>{g.value.total=j.value.length;const t=(g.value.currentPage-1)*g.value.pageSize,e=t+g.value.pageSize;return j.value.slice(t,e)});ue(x,()=>{g.value.currentPage=1}),de(()=>{H(),U()});const H=async()=>{try{const t=await k.get(`${y}/settings`);t.data&&t.data.cookiecloud&&(u.value.url=t.data.cookiecloud.url||"",u.value.key=t.data.cookiecloud.key||"",u.value.e2e_password="")}catch{c.error("加载CookieCloud配置失败！")}},U=async()=>{R.value=!0;try{const[t,e,s]=await Promise.all([k.get(`${y}/sites`,{params:{filter_by_torrents:"all"}}),k.get(`${y}/sites`,{params:{filter_by_torrents:"active"}}),k.get(`${y}/sites/status`)]);E.value=t.data,I.value=new Set((e.data||[]).map(n=>n.site)),F.value=s.data}catch{c.error("获取站点列表失败！")}finally{R.value=!1}},Q=()=>{g.value.currentPage=1},W=({row:t})=>O.value?T(t)?"":"row-config-incomplete":"",X=async()=>{if(!u.value.url||!u.value.key){c.warning("CookieCloud URL 和 KEY 不能为空！");return}$.value=!0;try{await k.post(`${y}/settings`,{cookiecloud:u.value});const t=await k.post(`${y}/cookiecloud/sync`,u.value);if(t.data.success){let e=t.data.message;e&&(e=e.replace(/在 CookieCloud 中另有 \d+ 个未匹配的 Cookie。?/,"")),c.success(`配置已保存. ${e||"同步完成！"}`),await U()}else c.error(t.data.message||"同步失败，但配置已保存。")}catch(t){const e=t.response?.data?.message||"操作失败，请检查网络或后端服务。";c.error(e)}finally{$.value=!1}},G=t=>{const e=JSON.parse(JSON.stringify(t));i.value=e,C.value=!0},Z=async()=>{L.value=!0;try{const t=JSON.parse(JSON.stringify(i.value));t.cookie&&(t.cookie=t.cookie.trim());const e=await k.post(`${y}/sites/update`,t);e.data.success?(c.success(e.data.message),C.value=!1,await U()):c.error(e.data.message||"操作失败！")}catch(t){const e=t.response?.data?.message||"请求失败，请检查网络或后端服务。";c.error(e)}finally{L.value=!1}},ee=t=>{_e.confirm("","警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0,message:`您确定要删除站点【${t.nickname}】吗？<br/>可以通过修改 config.json 然后重启恢复。`}).then(async()=>{try{const e=await k.post(`${y}/sites/delete`,{id:t.id});e.data.success?(c.success("站点已删除。"),await U()):c.error(e.data.message||"删除失败！")}catch(e){const s=e.response?.data?.message||"删除请求失败。";c.error(s)}}).catch(()=>{c.info("操作已取消。")})};return(t,e)=>{const s=m("el-input"),n=m("el-form-item"),w=m("el-icon"),v=m("el-button"),A=m("el-form"),_=m("el-table-column"),V=m("el-tag"),te=m("el-table"),D=m("el-radio-button"),le=m("el-radio-group"),oe=m("el-pagination"),ae=m("el-input-number"),se=m("el-dialog"),ne=ge("loading");return f(),b("div",ke,[d("div",ye,[o(A,{model:u.value,inline:"",class:"cookie-cloud-form"},{default:a(()=>[o(n,{label:"CookieCloud"},{default:a(()=>[o(s,{modelValue:u.value.url,"onUpdate:modelValue":e[0]||(e[0]=l=>u.value.url=l),placeholder:"http://127.0.0.1:8088",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),o(n,{label:"KEY"},{default:a(()=>[o(s,{modelValue:u.value.key,"onUpdate:modelValue":e[1]||(e[1]=l=>u.value.key=l),placeholder:"KEY (UUID)",clearable:"",style:{width:"100px"}},null,8,["modelValue"])]),_:1}),o(n,{label:"端对端密码"},{default:a(()=>[o(s,{modelValue:u.value.e2e_password,"onUpdate:modelValue":e[2]||(e[2]=l=>u.value.e2e_password=l),type:"password","show-password":"",placeholder:"端对端加密密码",clearable:"",style:{width:"125px"}},null,8,["modelValue"])]),_:1}),o(n,null,{default:a(()=>[o(v,{type:"primary",size:"large",onClick:X,loading:$.value},{default:a(()=>[o(w,null,{default:a(()=>[o(z(ce))]),_:1}),e[17]||(e[17]=d("span",null,"同步Cookie",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),d("div",we,[o(s,{modelValue:x.value,"onUpdate:modelValue":e[3]||(e[3]=l=>x.value=l),placeholder:"搜索站点昵称/标识/官组",clearable:"","prefix-icon":z(me),class:"search-input"},null,8,["modelValue","prefix-icon"])])]),pe((f(),b("div",be,[o(te,{data:q.value,class:"settings-table glass-table",height:"100%","row-class-name":W},{default:a(()=>[o(_,{prop:"nickname",label:"站点昵称",width:"100",sortable:""}),o(_,{label:"支持",width:"100",align:"center"},{default:a(l=>[N(l.row)==="both"?(f(),b("span",Ve," 源站/目标站 ")):N(l.row)==="source"?(f(),b("span",Se," 源站 ")):N(l.row)==="target"?(f(),b("span",Ce," 目标站 ")):J("",!0)]),_:1}),o(_,{prop:"site",label:"站点标识",width:"100","show-overflow-tooltip":""}),o(_,{prop:"base_url",label:"基础URL",width:"150","show-overflow-tooltip":""}),o(_,{prop:"group",label:"官组","show-overflow-tooltip":""}),o(_,{label:"限速",width:"100",align:"center"},{default:a(l=>[d("div",he,[l.row.speed_limit==0?(f(),h(V,{key:0,type:"error",size:"small"},{default:a(()=>[...e[18]||(e[18]=[r(" 当前不限速，重启恢复默认限速 ",-1)])]),_:1})):l.row.speed_limit>999?(f(),h(V,{key:1,type:"success",size:"small"},{default:a(()=>[...e[19]||(e[19]=[r(" 不限速 ",-1)])]),_:1})):(f(),h(V,{key:2,type:"primary",size:"small"},{default:a(()=>[r(B(l.row.speed_limit)+" MB/s ",1)]),_:2},1024))])]),_:1}),o(_,{label:"Cookie",width:"100",align:"center"},{default:a(l=>[o(V,{type:l.row.has_cookie?"success":"danger"},{default:a(()=>[r(B(l.row.has_cookie?"已配置":"未配置"),1)]),_:2},1032,["type"])]),_:1}),o(_,{label:"Passkey",width:"100",align:"center"},{default:a(l=>[["hddolby","m-team","hdtime","rousi"].includes(l.row.site)?(f(),h(V,{key:0,type:l.row.has_passkey?"success":"danger"},{default:a(()=>[r(B(l.row.has_passkey?"已配置":"未配置"),1)]),_:2},1032,["type"])):(f(),h(V,{key:1,type:"success"},{default:a(()=>[...e[20]||(e[20]=[r(" 自动获取 ",-1)])]),_:1}))]),_:1}),o(_,{label:"操作",width:"180",align:"center",fixed:"right"},{default:a(l=>[o(v,{type:"primary",icon:z(fe),link:"",onClick:ie=>G(l.row)},{default:a(()=>[...e[21]||(e[21]=[r(" 编辑 ",-1)])]),_:1},8,["icon","onClick"]),o(v,{type:"danger",icon:z(ve),link:"",onClick:ie=>ee(l.row)},{default:a(()=>[...e[22]||(e[22]=[r(" 删除 ",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])])),[[ne,R.value]]),d("div",xe,[o(le,{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=l=>S.value=l),onChange:Q},{default:a(()=>[o(D,{label:"existing_supported"},{default:a(()=>[...e[23]||(e[23]=[r("已有支持站点",-1)])]),_:1}),o(D,{label:"supported"},{default:a(()=>[...e[24]||(e[24]=[r("所有支持站点",-1)])]),_:1}),o(D,{label:"all"},{default:a(()=>[...e[25]||(e[25]=[r("所有站点",-1)])]),_:1})]),_:1},8,["modelValue"]),d("div",Ue,[d("div",Pe,B(g.value.pageSize)+" 条/页",1),o(oe,{"current-page":g.value.currentPage,"onUpdate:currentPage":e[5]||(e[5]=l=>g.value.currentPage=l),"page-size":g.value.pageSize,"onUpdate:pageSize":e[6]||(e[6]=l=>g.value.pageSize=l),total:g.value.total,layout:"total, prev, pager, next, jumper",background:""},null,8,["current-page","page-size","total"])])]),o(se,{modelValue:C.value,"onUpdate:modelValue":e[16]||(e[16]=l=>C.value=l),title:"编辑站点",width:"700px","close-on-click-modal":!1},{footer:a(()=>[d("span",Le,[o(v,{onClick:e[15]||(e[15]=l=>C.value=!1)},{default:a(()=>[...e[31]||(e[31]=[r("取消",-1)])]),_:1}),o(v,{type:"primary",onClick:Z,loading:L.value},{default:a(()=>[...e[32]||(e[32]=[r(" 保存 ",-1)])]),_:1},8,["loading"])])]),default:a(()=>[o(A,{model:i.value,ref_key:"siteFormRef",ref:K,"label-width":"140px","label-position":"left"},{default:a(()=>[o(n,{label:"站点标识",prop:"site",required:""},{default:a(()=>[o(s,{modelValue:i.value.site,"onUpdate:modelValue":e[7]||(e[7]=l=>i.value.site=l),placeholder:"例如：pt",disabled:""},null,8,["modelValue"]),e[26]||(e[26]=d("div",{class:"form-tip"},"站点标识不可修改。",-1))]),_:1}),o(n,{label:"站点昵称",prop:"nickname",required:""},{default:a(()=>[o(s,{modelValue:i.value.nickname,"onUpdate:modelValue":e[8]||(e[8]=l=>i.value.nickname=l),placeholder:"例如：PT站"},null,8,["modelValue"])]),_:1}),o(n,{label:"基础URL",prop:"base_url"},{default:a(()=>[o(s,{modelValue:i.value.base_url,"onUpdate:modelValue":e[9]||(e[9]=l=>i.value.base_url=l),placeholder:"例如：pt.com"},null,8,["modelValue"]),e[27]||(e[27]=d("div",{class:"form-tip"},"用于拼接种子详情页链接。",-1))]),_:1}),o(n,{label:"Tracker域名",prop:"special_tracker_domain"},{default:a(()=>[o(s,{modelValue:i.value.special_tracker_domain,"onUpdate:modelValue":e[10]||(e[10]=l=>i.value.special_tracker_domain=l),placeholder:"例如：pt-tracker.com"},null,8,["modelValue"]),e[28]||(e[28]=d("div",{class:"form-tip"}," 如果站点的Tracker域名与主域名的二级域名（则域名去掉前缀后缀部分）不同，请在此填写。 ",-1))]),_:1}),o(n,{label:"关联官组",prop:"group"},{default:a(()=>[o(s,{modelValue:i.value.group,"onUpdate:modelValue":e[11]||(e[11]=l=>i.value.group=l),placeholder:"例如：PT, PTWEB"},null,8,["modelValue"]),e[29]||(e[29]=d("div",{class:"form-tip"},"用于识别种子所属发布组，多个组用英文逗号(,)分隔。",-1))]),_:1}),o(n,{label:"Cookie",prop:"cookie"},{default:a(()=>[o(s,{modelValue:i.value.cookie,"onUpdate:modelValue":e[12]||(e[12]=l=>i.value.cookie=l),type:"textarea",rows:3,placeholder:"从浏览器获取的Cookie字符串"},null,8,["modelValue"])]),_:1}),o(n,{label:"Passkey",prop:"passkey"},{default:a(()=>[o(s,{modelValue:i.value.passkey,"onUpdate:modelValue":e[13]||(e[13]=l=>i.value.passkey=l),placeholder:"站点的Passkey"},null,8,["modelValue"]),i.value.site==="hddolby"?(f(),b("div",ze," 杜比的passkey为种子详情页复制种子链接时downhash=后的部分 ")):i.value.site==="newrousi"?(f(),b("div",Be," 肉丝的passkey为个人用户-设置-passkey ")):J("",!0)]),_:1}),o(n,{label:"上传限速 (MB/s)",prop:"speed_limit"},{default:a(()=>[o(ae,{modelValue:i.value.speed_limit,"onUpdate:modelValue":e[14]||(e[14]=l=>i.value.speed_limit=l),min:0,max:1e3,placeholder:"为防止失误操作导致超速，当设置为 0 时重启会自动设置为默认限速",style:{width:"100%"}},null,8,["modelValue"]),e[30]||(e[30]=d("div",{class:"form-tip",style:{color:"red","font-size":"14px"}},[r(" 单位为 MB/s，为防止误操作导致超速，当设置为 0 时重启会恢复默认限速"),d("br"),r(" 如缺点设置不限速可输入一个极大的数值，超过 999 会显示不限速 ")],-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Ne=re(Re,[["__scopeId","data-v-6c79011c"]]);export{Ne as default};
