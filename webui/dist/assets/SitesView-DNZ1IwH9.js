import{d as re,r as _,c as E,o as ie,a as u,i as s,u as R,v as de,m as p,w as o,e as t,f as c,k as v,x as ue,U as ce,g as M,t as d,F as S,l as B,j as m,h as r,z as W,p as _e}from"./index-DKGo2H6i.js";const pe={class:"sites-view-container"},ve={class:"layout-wrapper"},fe={class:"quadrant glass-card glass-rounded"},me={class:"table-wrapper"},he={class:"quadrant glass-card glass-rounded"},ge={class:"quadrant-title",style:{display:"flex","align-items":"center",gap:"10px"}},ye={class:"table-wrapper"},be={class:"quadrant local-scan-quadrant glass-card glass-rounded"},we={class:"scan-header"},xe={class:"scan-controls"},ke={style:{float:"right",color:"#8492a6","font-size":"13px"}},ze={key:0,class:"scan-summary glass-card glass-rounded"},Ve={class:"stat-item"},Se={class:"stat-value"},Be={class:"stat-item"},qe={class:"stat-value"},Ce={class:"stat-item stat-danger"},Ee={class:"stat-value"},Me={class:"stat-item stat-warning"},Ae={class:"stat-value"},De={class:"stat-item stat-success"},Fe={class:"stat-value"},Ue={key:1,class:"scan-results glass-card glass-rounded"},Pe={style:{display:"flex","align-items":"center",gap:"12px"}},$e={class:"tab-label"},je={class:"tab-label"},Ne={class:"tab-label"},Re={class:"tab-content-area"},Te={key:0,class:"tab-content"},Le={key:1,class:"tab-content"},Ge={key:2,class:"tab-content"},We={key:1},Ke={key:2,"element-loading-text":"正在扫描本地文件...","element-loading-background":"transparent",class:"loading-container"},Oe={key:3,style:{display:"flex","align-items":"center","justify-content":"center",flex:"1"}},He=re({__name:"SitesView",emits:["ready"],setup(Je,{emit:K}){const O=K,A=_(!0),D=_(!0),q=_([]),F=_([]),x=_(""),b=_(!1),k=_("missing"),n=_(null),z=_(""),T=_([]),h=_(""),H=E(()=>{if(!n.value)return[];const a=new Set;return n.value.missing_files&&n.value.missing_files.forEach(e=>a.add(e.save_path)),n.value.orphaned_files&&n.value.orphaned_files.forEach(e=>a.add(e.path)),n.value.synced_torrents&&n.value.synced_torrents.forEach(e=>a.add(e.path)),Array.from(a).sort()}),J=E(()=>n.value?.missing_files?h.value?n.value.missing_files.filter(a=>a.save_path===h.value):n.value.missing_files:[]),Q=E(()=>n.value?.orphaned_files?h.value?n.value.orphaned_files.filter(a=>a.path===h.value):n.value.orphaned_files:[]),X=E(()=>n.value?.synced_torrents?h.value?n.value.synced_torrents.filter(a=>a.path===h.value):n.value.synced_torrents:[]),C=(a,e=2)=>{if(!+a)return"0 Bytes";const f=1024,i=e<0?0:e,g=["Bytes","KB","MB","GB","TB","PB"],w=Math.floor(Math.log(a)/Math.log(f));return`${parseFloat((a/Math.pow(f,w)).toFixed(i))} ${g[w]}`},Y=async()=>{A.value=!0;try{const a=await fetch("/api/site_stats");if(!a.ok)throw new Error(`网络响应错误: ${a.status}`);const e=await a.json();q.value=Array.isArray(e)?e:[]}catch(a){console.error("获取站点统计数据失败:",a),q.value=[]}finally{A.value=!1}},L=async()=>{D.value=!0;try{const a=x.value?`/api/group_stats?site=${encodeURIComponent(x.value)}`:"/api/group_stats",e=await fetch(a);if(!e.ok)throw new Error(`网络响应错误: ${e.status}`);const f=await e.json();F.value=Array.isArray(f)?f:[]}catch(a){console.error("获取官组统计数据失败:",a),F.value=[]}finally{D.value=!1}},Z=()=>{L()},I=async()=>{try{const a=await M.get("/api/local_query/downloaders_with_paths");T.value=a.data.downloaders||[]}catch(a){console.error("获取路径列表失败:",a)}},ee=async()=>{try{const a=await M.get("/api/local_query/scan/cache");n.value=a.data,console.log("已加载缓存的扫描结果")}catch(a){M.isAxiosError(a)&&a.response?.status!==404&&console.error("获取缓存扫描结果失败:",a)}},te=async()=>{b.value=!0,n.value=null;try{const a=z.value?`/api/local_query/scan?path=${encodeURIComponent(z.value)}`:"/api/local_query/scan",e=await M.post(a);n.value=e.data,W.success("扫描完成！")}catch(a){console.error("扫描失败:",a),W.error("扫描失败，请查看控制台获取详情")}finally{b.value=!1}},G=async()=>{await Promise.all([Y(),L(),I(),ee()])};return ie(()=>{G(),O("ready",G)}),(a,e)=>{const f=c("el-empty"),i=c("el-table-column"),g=c("el-table"),w=c("el-option"),U=c("el-select"),ae=c("el-option-group"),se=c("el-button"),V=c("el-col"),le=c("el-row"),P=c("el-badge"),$=c("el-tab-pane"),ne=c("el-tabs"),j=c("el-tag"),N=de("loading");return r(),u("div",pe,[s("div",ve,[s("div",fe,[e[4]||(e[4]=s("h2",{class:"quadrant-title"},"做种站点统计",-1)),s("div",me,[R((r(),p(g,{data:q.value,class:"stats-table glass-table",border:"",height:"100%","default-sort":{prop:"total_size",order:"descending"}},{empty:o(()=>[t(f,{description:"无站点数据"})]),default:o(()=>[t(i,{prop:"site_name",label:"站点名称",align:"center",sortable:"","min-width":"120"}),t(i,{prop:"torrent_count",label:"做种数量",sortable:"",align:"center"}),t(i,{prop:"total_size",label:"做种总体积",sortable:"",align:"center","min-width":"100"},{default:o(l=>[s("span",null,d(C(l.row.total_size)),1)]),_:1})]),_:1},8,["data"])),[[N,A.value]])])]),s("div",he,[s("h2",ge,[e[5]||(e[5]=s("span",null,"做种官组统计",-1)),t(U,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=l=>x.value=l),placeholder:"全部站点",clearable:"",filterable:"",size:"small",style:{width:"240px"},onChange:Z},{default:o(()=>[(r(!0),u(S,null,B(q.value,l=>(r(),p(w,{key:l.site_name,label:l.site_name,value:l.site_name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),s("div",ye,[R((r(),p(g,{data:F.value,class:"stats-table glass-table",border:"",height:"100%","default-sort":{prop:"total_size",order:"descending"}},{empty:o(()=>[t(f,{description:"无官组数据"})]),default:o(()=>[t(i,{prop:"site_name",label:"所属站点",align:"center",sortable:"",width:"110"}),t(i,{label:(x.value,"官组"),prop:"group_suffix",sortable:"",align:"center"},null,8,["label"]),t(i,{prop:"torrent_count",label:"数量",sortable:"",align:"center",width:"80"}),t(i,{prop:"total_size",label:"体积",sortable:"",align:"center",width:"90"},{default:o(l=>[s("span",null,d(C(l.row.total_size)),1)]),_:1})]),_:1},8,["data"])),[[N,D.value]])])]),s("div",be,[s("div",we,[e[6]||(e[6]=s("div",{class:"scan-header-left"},[s("h2",{class:"quadrant-title"},"本地文件扫描"),s("p",{class:"scan-description"},"扫描数据库中所有种子的保存路径，找出本地已删除的文件或未被任务引用的孤立文件。为防止误删除种子，所以不提供一键删除功能。")],-1)),s("div",xe,[t(U,{modelValue:z.value,"onUpdate:modelValue":e[1]||(e[1]=l=>z.value=l),clearable:"",placeholder:"选择路径(可选)",filterable:"",size:"default",style:{width:"280px","margin-right":"10px"}},{default:o(()=>[(r(!0),u(S,null,B(T.value,l=>(r(),p(ae,{key:l.id,label:l.name},{default:o(()=>[(r(!0),u(S,null,B(l.paths,y=>(r(),p(w,{key:y.path,label:y.path,value:y.path},{default:o(()=>[s("span",null,d(y.path),1),s("span",ke,"("+d(y.count)+")",1)]),_:2},1032,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"]),t(se,{type:"primary",onClick:te,loading:b.value,icon:ue(ce)},{default:o(()=>[m(d(z.value?"扫描选定路径":"扫描全部路径"),1)]),_:1},8,["loading","icon"])])]),n.value?(r(),u("div",ze,[t(le,{gutter:16},{default:o(()=>[t(V,{span:4},{default:o(()=>[s("div",Ve,[s("div",Se,d(n.value.scan_summary.total_torrents),1),e[7]||(e[7]=s("div",{class:"stat-label"},"总种子数",-1))])]),_:1}),t(V,{span:5},{default:o(()=>[s("div",Be,[s("div",qe,d(n.value.scan_summary.total_local_items),1),e[8]||(e[8]=s("div",{class:"stat-label"},"本地文件数",-1))])]),_:1}),t(V,{span:5},{default:o(()=>[s("div",Ce,[s("div",Ee,d(n.value.scan_summary.missing_count),1),e[9]||(e[9]=s("div",{class:"stat-label"},"缺失文件",-1))])]),_:1}),t(V,{span:5},{default:o(()=>[s("div",Me,[s("div",Ae,d(n.value.scan_summary.orphaned_count),1),e[10]||(e[10]=s("div",{class:"stat-label"},"孤立文件",-1))])]),_:1}),t(V,{span:5},{default:o(()=>[s("div",De,[s("div",Fe,d(n.value.scan_summary.synced_count),1),e[11]||(e[11]=s("div",{class:"stat-label"},"正常做种",-1))])]),_:1})]),_:1})])):v("",!0),n.value?(r(),u("div",Ue,[s("div",Pe,[t(ne,{modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=l=>k.value=l),style:{flex:"0 0 auto"}},{default:o(()=>[t($,{name:"missing"},{label:o(()=>[s("span",$e,[e[12]||(e[12]=m(" 缺失文件 ",-1)),n.value.scan_summary.missing_count>0?(r(),p(P,{key:0,value:n.value.scan_summary.missing_count,type:"danger",max:999999},null,8,["value"])):v("",!0)])]),_:1}),t($,{name:"orphaned"},{label:o(()=>[s("span",je,[e[13]||(e[13]=m(" 孤立文件 ",-1)),n.value.scan_summary.orphaned_count>0?(r(),p(P,{key:0,value:n.value.scan_summary.orphaned_count,type:"warning",max:999999},null,8,["value"])):v("",!0)])]),_:1}),t($,{name:"synced"},{label:o(()=>[s("span",Ne,[e[14]||(e[14]=m(" 正常做种 ",-1)),n.value.scan_summary.synced_count>0?(r(),p(P,{key:0,value:n.value.scan_summary.synced_count,type:"success",max:999999},null,8,["value"])):v("",!0)])]),_:1})]),_:1},8,["modelValue"]),t(U,{modelValue:h.value,"onUpdate:modelValue":e[3]||(e[3]=l=>h.value=l),placeholder:"筛选路径",clearable:"",filterable:"",style:{width:"240px"}},{default:o(()=>[(r(!0),u(S,null,B(H.value,l=>(r(),p(w,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),s("div",Re,[k.value==="missing"?(r(),u("div",Te,[t(g,{data:J.value,class:"glass-table glass-transition",height:"100%","default-sort":{prop:"size",order:"descending"}},{default:o(()=>[t(i,{prop:"name",label:"种子名称","show-overflow-tooltip":"",align:"left","header-align":"center"}),t(i,{prop:"save_path",label:"保存路径",align:"center",width:"250","show-overflow-tooltip":"","header-align":"center"}),t(i,{prop:"size",label:"大小",width:"110",sortable:"",align:"center"},{default:o(({row:l})=>[m(d(C(l.size)),1)]),_:1}),t(i,{prop:"downloader_name",label:"下载器",width:"120",align:"center"})]),_:1},8,["data"])])):v("",!0),k.value==="orphaned"?(r(),u("div",Le,[t(g,{data:Q.value,class:"glass-table glass-transition",height:"100%","default-sort":{prop:"size",order:"descending"}},{default:o(()=>[t(i,{prop:"name",label:"文件/文件夹名称","show-overflow-tooltip":"",align:"left","header-align":"center"}),t(i,{prop:"path",label:"所在路径",width:"250",align:"center","show-overflow-tooltip":{placement:"left"},"header-align":"center"}),t(i,{prop:"size",label:"大小",width:"120",sortable:"",align:"center"},{default:o(({row:l})=>[m(d(l.size?C(l.size):"未知"),1)]),_:1}),t(i,{prop:"is_file",label:"类型",width:"120",align:"center","header-align":"center"},{default:o(({row:l})=>[t(j,{type:l.is_file?"success":"info",size:"small"},{default:o(()=>[m(d(l.is_file?"文件":"文件夹"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):v("",!0),k.value==="synced"?(r(),u("div",Ge,[t(g,{data:X.value,class:"glass-table glass-transition",height:"100%"},{default:o(()=>[t(i,{prop:"name",label:"名称","show-overflow-tooltip":"",align:"left","header-align":"center"}),t(i,{prop:"path",label:"路径",width:"250","show-overflow-tooltip":"",align:"center","header-align":"center"}),t(i,{prop:"torrents_count",label:"任务数",width:"120",align:"center","header-align":"center"},{default:o(({row:l})=>[l.torrents_count>0?(r(),p(j,{key:0,type:"warning",size:"small"},{default:o(()=>[m(d(l.torrents_count),1)]),_:2},1024)):(r(),u("span",We,d(l.torrents_count),1))]),_:1}),t(i,{label:"下载器",width:"120",align:"center","header-align":"center"},{default:o(({row:l})=>[(r(!0),u(S,null,B(l.downloader_names,(y,oe)=>(r(),p(j,{key:oe,size:"small",style:{"margin-right":"4px"}},{default:o(()=>[m(d(y),1)]),_:2},1024))),128))]),_:1})]),_:1},8,["data"])])):v("",!0)])])):v("",!0),b.value?R((r(),u("div",Ke,null,512)),[[N,b.value]]):v("",!0),!n.value&&!b.value?(r(),u("div",Oe,[t(f,{description:"点击扫描按钮进行本地文件检查"})])):v("",!0)])])])}}}),Xe=_e(He,[["__scopeId","data-v-88d09628"]]);export{Xe as default};
